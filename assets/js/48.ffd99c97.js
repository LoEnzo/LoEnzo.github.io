(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{550:function(s,a,t){s.exports=t.p+"assets/img/K3sProblem-01.2effdbb9.png"},707:function(s,a,t){"use strict";t.r(a);var e=t(3),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[s._v("因为个人像学习K8s相关云服务，k3s占用资源少，所以个人部署在阿里云服务器上，相关服务也都使用k3s大家，这里记录一些遇到的问题，没有能及时记录，所以很零散")])]),s._v(" "),a("h2",{attrs:{id:"服务器崩了自动重启失败分享"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器崩了自动重启失败分享"}},[s._v("#")]),s._v(" 服务器崩了自动重启失败分享")]),s._v(" "),a("p",[s._v("环境")]),s._v(" "),a("p",[s._v("阿里云 轻量化服务器")]),s._v(" "),a("h3",{attrs:{id:"版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#版本"}},[s._v("#")]),s._v(" 版本")]),s._v(" "),a("p",[s._v("VERSION:\nv1.25.5+k3s2 (de654222)")]),s._v(" "),a("h3",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),a("p",[s._v("10-13号到10-16号，服务器 CPU 占用激增到100%，磁盘读写增加，上面就部署了一些个人博客和一些练习项目，包含开源的一些三方chatGpt")]),s._v(" "),a("p",[a("img",{attrs:{src:t(550),alt:"阿里云服务器监控"}})]),s._v(" "),a("p",[s._v("发现问题是自己部署的chatGpt无法访问了，登陆服务器看看，结果服务器登陆不上，CPU占用太多，ssh请求都没法相应")]),s._v(" "),a("h3",{attrs:{id:"问题排查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题排查"}},[s._v("#")]),s._v(" 问题排查")]),s._v(" "),a("p",[s._v("首先印象中自己近期是动服务器上面什么东西的，其次怀疑难道是部署的ChatGpt服务被恶意攻击了？（练习服务器，端口全开，防火墙默认的），看了下网络流量，那段时间没啥情况，最后也没排查出个啥")]),s._v(" "),a("h3",{attrs:{id:"问题解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题解决"}},[s._v("#")]),s._v(" 问题解决")]),s._v(" "),a("p",[s._v("首先得进服务器呗")]),s._v(" "),a("ol",[a("li",[s._v("多尝试了几次，ssh确实没法登陆，也就意味着我没法重启k3s，把负载这些降下来；")]),s._v(" "),a("li",[s._v("阿里云提供远程服务，尝试后同样无解；")]),s._v(" "),a("li",[s._v("个人练习服务器没考虑这么多，快照备份也没做，无解；")]),s._v(" "),a("li",[s._v("一键重启，尝试了，相应了很久，感觉起码有2小时，解决部分，能进服务器了")])]),s._v(" "),a("p",[s._v("k3s 服务没有自动重启")]),s._v(" "),a("ol",[a("li",[s._v("执行重启 "),a("code",[s._v("service k3s start")]),s._v(", 报错了，查看状态 "),a("code",[s._v("systemctl status k3s.service")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service k3s restart")]),s._v("\nRedirecting to /bin/systemctl restart k3s.service\nJob "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" k3s.service failed because the control process exited with error code.\nSee "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"systemctl status k3s.service"')]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"journalctl -xe"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" details.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status k3s.service")]),s._v("\n● k3s.service - Lightweight Kubernetes\n   Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/etc/systemd/system/k3s.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: disabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   Active: activating "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auto-restart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Result: exit-code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Mon "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2023")]),s._v("-01-16 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:01 CST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 2s ago\n     Docs: https://k3s.io\n  Process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37172")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/k3s server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37171")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/modprobe overlay "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37169")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/sbin/modprobe br_netfilter "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37166")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStartPre")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/bin/sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-xc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" /usr/bin/systemctl is-enabled "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--quiet")]),s._v(" nm-cloud-setup.service "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37172")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nJan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:01 iZbp10kr3w2ijuyctukq43Z systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Failed to start Lightweight Kubernetes.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# journalctl -xe")]),s._v("\nJan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:06 iZbp10kr3w2ijuyctukq43Z k3s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37195")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2023-01-16T13:15:06+08:00"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Kine available at unix://kine.sock"')]),s._v("\nJan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:06 iZbp10kr3w2ijuyctukq43Z k3s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("37195")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2023-01-16T13:15:06+08:00"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("level")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("fatal "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v('"starting kubernetes: preparing server: failed to normalize token'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" m"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nJan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:06 iZbp10kr3w2ijuyctukq43Z systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": k3s.service: Main process exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/FAILURE\nJan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:06 iZbp10kr3w2ijuyctukq43Z systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": k3s.service: Failed with result "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exit-code'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n-- Subject: Unit failed\n-- Defined-By: systemd\n-- Support: https://access.redhat.com/support\n-- \n-- The unit k3s.service has entered the "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'failed'")]),s._v(" state with result "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exit-code'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\nJan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":15:06 iZbp10kr3w2ijuyctukq43Z systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Failed to start Lightweight Kubernetes.\n-- Subject: Unit k3s.service has failed\n-- Defined-By: systemd\n-- Support: https://access.redhat.com/support\n-- \n-- Unit k3s.service has failed.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v('根据提示继续执行 "journalctl -xe" 查看详细情况')]),s._v(" "),a("p",[s._v("详细情况没有截图，因为没查到日志记录，没及时做备份，这个得后面注意了，找了下以前的，只有这句报错了 "),a("code",[s._v("starting kubernetes: preparing server: failed to normalize token; must be **in** format K10<CA-HASH>::<USERNAME>:<PASSWORD> **or** <PASSWORD>")]),s._v(" ,大概意思是 "),a("code",[s._v("/var/lib/rancher/k3s/server/node-token")]),s._v(" 这个下面令牌没东西了，正确的格式应该是上面这种，我cat了下，的确没有东西了，")]),s._v(" "),a("p",[s._v("尝试了重新注册生成，报错\n尝试了重装，就是一条指令那种，好像会覆盖，记得以前执行过，还是报错")]),s._v(" "),a("p",[s._v("百度没找到对应错误")]),s._v(" "),a("p",[s._v("重新翻我的博客，找到了记录，上面的日志就是 今年 1月份的时候遇到的问题，没想到10月份再次遇到了，"),a("a",{attrs:{href:"https://loenzo.top/blogs/k8sNotes/K3s.html#%E9%97%AE%E9%A2%98",title:"当时的记录",target:"_blank",rel:"noopener noreferrer"}},[s._v("当时的记录"),a("OutboundLink")],1),s._v("，详细的参考链接现在已经不可访问了")]),s._v(" "),a("h3",{attrs:{id:"解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[s._v("#")]),s._v(" 解决")]),s._v(" "),a("p",[s._v("最终的解决方式很简单，就是把这个文件 "),a("code",[s._v("/var/lib/rancher/k3s/server/node-token")]),s._v("删除掉，再重启K3s服务就OK了")]),s._v(" "),a("p",[s._v("严重怀疑阿里云服务器有问题，但是我没有证据.....")]),s._v(" "),a("h3",{attrs:{id:"回顾"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#回顾"}},[s._v("#")]),s._v(" 回顾")]),s._v(" "),a("p",[s._v("每次遇到问题后，整个问题 "),a("code",[s._v("排查解决过程是有记录")]),s._v("的必要的，比如这次，要是没想起翻一下自己当时记录，估计只有把服务卸载了完整重装了，重启启动这些pod是个繁琐的工程了（主要是菜）")]),s._v(" "),a("h2",{attrs:{id:"证书过期怎么解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#证书过期怎么解"}},[s._v("#")]),s._v(" 证书过期怎么解")]),s._v(" "),a("h3",{attrs:{id:"环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),a("p",[s._v("阿里云 轻量化服务器")]),s._v(" "),a("h3",{attrs:{id:"版本-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#版本-2"}},[s._v("#")]),s._v(" 版本")]),s._v(" "),a("p",[s._v("VERSION:\nv1.25.5+k3s2 (de654222)")]),s._v(" "),a("h3",{attrs:{id:"问题-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题-2"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),a("p",[s._v("多事之秋，在这个问题前 服务器崩了自动重启失败分享 , 也遇到了自己部署的服务没法访问的问题")]),s._v(" "),a("h3",{attrs:{id:"排查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#排查"}},[s._v("#")]),s._v(" 排查")]),s._v(" "),a("p",[s._v("同样查看日志，查看状态 "),a("code",[s._v("systemctl status k3s.service")]),s._v(' "journalctl -xe" 查看详细情况，报错如下：\n'),a("code",[s._v('"Unable to authenticate the request" err="[x509: certificate has expired or is not yet valid: current time')]),s._v("，看提示就是啥认证、证书类问题，百度了下，k3s证书会过去，算了下时间，自己的部署时间确过了一年")]),s._v(" "),a("p",[s._v("查看证书对应时间 "),a("code",[s._v("for i in<span> </span>")]),s._v("ls /var/lib/rancher/k3s/server/tls/*.crt "),a("code",[s._v("; do echo $i; openssl x509 -enddate -noout -in $i; done")])]),s._v(" "),a("h3",{attrs:{id:"解决-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决-2"}},[s._v("#")]),s._v(" 解决")]),s._v(" "),a("p",[s._v("主要通过修改系统时间的方式让证书时间变长\n1、关闭时间同步")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("timedatectl set-ntp no\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("2、查看k3s过期时间")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /var/lib/rancher/k3s/server/tls/*.crt"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" openssl x509 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-enddate")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-noout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("3、删除 secret k3s-serving")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl --insecure-skip-tls-verify "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system delete secrets k3s-serving\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("4、删除系统中的文件dynamic-cert.json")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /var/lib/rancher/k3s/server/tls/dynamic-cert.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("5、设置时间系统时间到 2050-01-01")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20500101")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("6、重启k3s")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" k3s restart\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("7、查看过期时间")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /var/lib/rancher/k3s/server/tls/*.crt"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" openssl x509 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-enddate")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-noout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("8、打开时间同步")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("timedatectl set-ntp "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("重新 查看证书情况详情如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for i in `ls /var/lib/rancher/k3s/server/tls/*.crt`; do echo $i; openssl x509 -enddate -noout -in $i; done")]),s._v("\n/var/lib/rancher/k3s/server/tls/client-admin.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-ca.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" 08:02:59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2031")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-controller.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-k3s-cloud-controller.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-k3s-controller.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-kube-proxy.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/client-scheduler.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/request-header-ca.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" 08:02:59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2031")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/server-ca.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(" 08:02:59 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2031")]),s._v(" GMT\n/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("notAfter")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":00:11 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2050")]),s._v(" GMT\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("有两条是 在 2031年的，不过不影响，毕竟明年咱就不续期了（低价格续期就三年）....哈哈哈....")]),s._v(" "),a("p",[s._v("检查：重新检查各个服务是否正常")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n blog")]),s._v("\nNAME                            READY   STATUS    RESTARTS        AGE\ndailycheckin-6f7c99c968-7nm7t   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("6d1h ago"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    264d\nblog-8698b4655-5576p            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("6d1h ago"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   81d\nblog-8698b4655-q2xmk            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("6d1h ago"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   81d\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@iZbp10kr3w2ijuyctukq43Z ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n pandora")]),s._v("\nNAME                       READY   STATUS    RESTARTS       AGE\npandora-6d9c5db8c6-9wcj9   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("6d1h ago"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   73d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("都是OK的，万事大吉....")]),s._v(" "),a("p",[s._v("当然啦，正规流程可不是这样的哈....")])])}),[],!1,null,null,null);a.default=r.exports}}]);